# osipov_bot

Система сбора и рассылки информации и формирования команд для студентов курсов Devman имени Ильи Осипова.

Представляет собой двух телеграм-ботов и базу данных, управляемую ORM Django.

## Выполняемые функции

### Телеграм-бот для студентов

Предназначен для общения со студентами при организации групповых проектов.
При любом действии пользователя в чате с ботом происходит проверка является ли этот пользователь студентом курсов, 
если нет, то выдается соответствующее сообщение и рекламная информация
![image](https://user-images.githubusercontent.com/22379662/172062471-5b7eb9a6-447d-41a4-a045-8ce07eeb378d.png)
Так же бот отслеживает статус пользователя относительно проекта.   
Если сейчас нет никаких активных проектов, то бот на попытку взаимодействия выдает сообщение:
```
Сейчас нет активного проекта. Как только он появится, я тебе напишу
```
Если открыта регистрация на новый проект, то бот начинает беседу с целью определиться с удобным графиком работы студента.  

Если студент уже озвучил свои пожелания о времени, то бот сообщает:
```
Подожди пока формируем группы, как будет готово - напишу
```
Когда же команды сформированы, то бот выдает описание команды в которую был записан студент.
```
Welcome aboard! Ты в команде ;)
Созвон вашей группы в 19:00
Проект менеджер: Тим @tim
Вот описание проекта: https://docs.google.com/......
Доска в Trello: https://trello.com/.......

Состав группы:
Михаил @Mikhail
Сергей @Serg
Александр @Aldr
```

Так как между перечисленными событиями может быть продолжительный период времени,
то бот умеет инициировать диалог с пользователем самостоятельно (не смотря на невозможность этого в API Telegram - ....Магия). Эта возможность достигается с помощью Расписания задач. Задача запускается через определенный интервал времени и проверяет необходимость начать регистрацию студентов на новый проект, либо оповестить студентов об их группах. Интервал для расписания, по-умолчанию 12 часов, задается в файле `.env` в секундах:
```
JOB_DELAY = 43200
```
Для запуска необходимо записать в файл `.env` переменную `TG_TOKEN` - токен бота.  
Запуск
```
python3 student_bot.py
```

### Телеграм-бот для менеджеров

Информирует их об их активных командах и временах созвона. Также при помощи бота можно указать время работы менеджера.

Для запуска необходимо записать в файл `.env` переменную `TG_PM_TOKEN` - токен бота

Запуск

        python3 manager_bot.py

### Админка Django

Здесь хранятся данные о пользователях, project-менеджерах и командах - как активных, так и архивных. Здесь же находится модель Start.
Создание новой записи в этой модели и установка галочки "Отправить запрос" инициирует телеграм-опрос среди активных студентов,
предлагая им выбрать записи. Установка второй галочки "Разослать сформированные команды" инициирует рассылку студентам, получившим команды,
соответствующей информации.

Для запуска рекомендуется записать в файл `.env` переменную `DJANGO_SECRET`

Запуск сервера

        manage.py runserver
        
Админка доступна по адресу `127.0.0.1:8000/admin`

## Вспомогательные скрипты

### read_students.py

Считывает из json-файла и записывает в базу данных информацию о студентах или project-менеджерах.

Использование

        python3 read_students.py [-s] [-m] [file]
        
- -s - считать в базу со студентами
- -m - считать в базу с project-менеджерами
- file - файл для чтения

### teams_making.py

Формирует команды по 3 человека из имеющихся студентов (для этого у них должны быть уже указаны желаемая дата начала проекта и удобное время для созвонов).
Формирование происходит по каждому доступнопму project-менеджеру по доступным ему временным получасовым слотам (по одной команде на слот)
Оставшихся студентов пока необходимо распределять вручную.

Запуск

        python3 teams_making.py
        
После формирования команд можно просмотреть их в админке, после чего поставить в соответствующем объекте модели Start галочку "Разослать сформированные команды"
